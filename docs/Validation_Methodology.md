# CircleSeeker 验证方法说明

**版本**: v1.1.0
**更新日期**: 2026-01-15

本文档描述了 CircleSeeker eccDNA 检测性能评估所使用的模拟验证方法。

---

## 1. 概述

CircleSeeker 验证采用**合成数据方法**，包括以下步骤：

1. 生成模拟参考基因组
2. 创建三种类型的合成 eccDNA reads（含已知真值）
3. 运行验证用的最小检测链路（minimap2 对齐 → um_classify → cecc_build）
4. 将预测结果与真值对比，计算性能指标

该方法可以精确测量 recall、precision 和 F1 分数，因为真实的 eccDNA 位置是完全已知的。

---

## 2. 模拟 eccDNA 类型

### 2.1 唯一型 eccDNA (UeccDNA)

**定义**：来自单一、唯一基因组位置的简单环状 DNA。

**模拟方法**：
- 随机选择基因组区域（长度：200-5,000 bp）
- 该区域必须唯一映射到参考基因组
- 生成单个环状分子

**占比**：总 eccDNA 的 70%

### 2.2 多映射型 eccDNA (MeccDNA)

**定义**：来自重复基因组区域的环状 DNA，可映射到多个位点。

**模拟方法**：
- 创建具有 2-10+ 个基因组拷贝的"重复家族"
- 每个家族有一个共识序列（100-500 bp 单元）
- 在拷贝间引入约 0.5% 的序列差异以模拟真实重复
- eccDNA reads 来源于这些多拷贝区域

**占比**：总 eccDNA 的 15%

### 2.3 嵌合型 eccDNA (CeccDNA)

**定义**：由多个非连续基因组片段组成的复杂环状 DNA。

**模拟方法**：
- 2-4 个基因组片段连接成一个环
- 片段可来自同一染色体（染色体内）或不同染色体（染色体间，约 30%）
- 每个片段：100-1,000 bp

**占比**：总 eccDNA 的 15%

---

## 3. 参考基因组构建

模拟参考基因组根据 eccDNA 数量**自动缩放**，以保持合理的重复序列密度：

| 参数 | 默认值 | 说明 |
|------|--------|------|
| 染色体数 | 5 | 染色体数量 |
| 目标重复覆盖度 | 1.5% | 基因组中重复序列的比例 |
| 最大重复覆盖度 | 30% | 禁用自动缩放时的上限 |

**计算公式**：
```
基因组大小 = (MeccDNA数量 × 每家族拷贝数 × 平均单元长度) / 目标覆盖度
```

这确保了大规模测试不会人为提高重复序列密度。

---

## 4. HiFi Read 模拟

模拟 reads 模仿 PacBio HiFi 特性：

| 参数 | 值 |
|------|-----|
| 错误率 | 0.1%（HiFi 典型值）|
| Read 结构 | eccDNA 序列的串联重复 |
| 拷贝数 | 可变（2-10×）|

---

## 5. 验证流程

```
┌─────────────────────────────────────────────────────────────────┐
│                       模拟阶段                                   │
├─────────────────────────────────────────────────────────────────┤
│  1. 生成参考基因组 (FASTA)                                       │
│  2. 创建 UeccDNA reads + 真值                                   │
│  3. 创建 MeccDNA reads + 真值                                   │
│  4. 创建 CeccDNA reads + 真值                                   │
│  5. 输出: simulated_reads.fa, ground_truth.csv                  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       检测阶段                                   │
├─────────────────────────────────────────────────────────────────┤
│  1. 运行验证用的最小链路                                        │
│     - minimap2 → 比对                                           │
│     - U/M 分类                                                  │
│     - CeccDNA 检测（LAST 优先；不可用时图方法回退）             │
│  2. 输出: uecc.csv, mecc.csv, cecc.csv                          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                       评估阶段                                   │
├─────────────────────────────────────────────────────────────────┤
│  1. 通过 read_id 匹配预测与真值                                  │
│  2. 计算每种 eccDNA 类型的 TP、FP、FN                           │
│  3. 计算 recall、precision、F1、accuracy                        │
│  4. 输出: validation_report.json                                │
└─────────────────────────────────────────────────────────────────┘
```

---

## 6. 评估指标

### 6.1 匹配策略

使用 **read_id** 作为主键将预测与真值匹配：

- **真阳性 (TP)**：预测的 read_id 存在于真值中且类型正确
- **假阳性 (FP)**：预测的 read_id 不在真值中，或类型错误
- **假阴性 (FN)**：真值中的 read_id 未被预测

### 6.2 指标定义

| 指标 | 公式 | 说明 |
|------|------|------|
| **召回率 (Recall)** | TP / (TP + FN) | 检测到的真实 eccDNA 比例 |
| **精确率 (Precision)** | TP / (TP + FP) | 正确预测的比例 |
| **F1 分数** | 2 × (P × R) / (P + R) | 精确率和召回率的调和平均 |
| **准确率 (Accuracy)** | TP / (TP + FP + FN) | 检测准确率（不适用 TN）|

**注意**：不使用真阴性 (TN)，因为搜索空间（所有可能的基因组区域）本质上是无限的。

---

## 7. 批量验证协议

为进行全面验证，我们采用**梯度测试**方法：

### 7.1 测试配置

| 参数 | 值 |
|------|-----|
| 规模 | 100, 500, 1,000, 3,000, 5,000, 10,000, 50,000, 100,000 |
| 每规模运行次数 | 10 |
| 随机种子 | 42-51（连续）|
| eccDNA 比例 | 70% U : 15% M : 15% C |

### 7.2 测试执行

```bash
python tests/simulation/batch_validation.py \
  --scales 100,500,1000,3000,5000,10000,50000,100000 \
  --runs 10 \
  --base-seed 42 \
  --threads 32
```

### 7.3 结果汇总

结果在多个层级汇总：
1. **单次运行**：每次测试的 TP/FP/FN
2. **按规模**：每个规模 10 次运行的平均指标
3. **总体**：所有 80 次运行的综合指标

---

## 8. 关键脚本

| 脚本 | 用途 |
|------|------|
| `tests/simulation/eccdna_simulator.py` | 生成合成参考基因组 + reads + 真值 |
| `tests/simulation/run_validation.py` | 运行单次端到端验证 |
| `tests/simulation/batch_validation.py` | 运行多规模梯度测试 |
| `tests/simulation/validation_metrics.py` | 计算 TP/FP/FN 和指标 |

---

## 9. 可重复性

所有模拟完全可重复：

- **固定随机种子**：每次运行使用确定性种子（42-51）
- **确定性基因组**：相同种子产生相同的参考基因组
- **确定性 reads**：相同种子产生相同的 eccDNA reads

重现特定测试：

```bash
python tests/simulation/run_validation.py \
  --simulation-dir output/simulation \
  --results-dir output/results \
  --num-uecc 700 --num-mecc 150 --num-cecc 150 \
  --seed 42
```

---

## 10. 局限性

1. **简化的基因组**：模拟参考基因组缺乏真实基因组的复杂性（转座子、片段重复等）
2. **理想化的 reads**：模拟 reads 具有均匀的错误分布
3. **无生物学噪声**：真实样本包含非 eccDNA 的环状分子
4. **类型边界**：U/M/C 分类边界的边缘案例可能与真实数据不同

尽管存在这些局限性，合成验证仍为算法开发和回归测试提供了严格、可重复的基准。

---

## 11. 理解 "Unclassified" Reads

在验证流程中，`UMeccClassifier.run()` 输出 `uecc_df`、`mecc_df` 和 `unclassified_df`。`unclassified.csv` 包含**在 U/M 阶段未被分类为 U 或 M** 的 reads：

- 大部分真实的 CeccDNA reads（预期由后续 `cecc_build` 步骤处理）
- 边界 U/M 样本（如 U 唯一性否决或 M 多位点覆盖不足）
- 低质量比对行

**最终检测状态**应通过检查 `uecc.csv`、`mecc.csv` 和 `cecc.csv` 来确定。只有三者都不包含的 reads 才是真正未检测到的。

---

## 12. 为什么 Recall 在不同种子间波动

在相同代码和环境下，**相同种子的结果是可重复的**。不同种子会改变模拟数据的"难度特征"：

- 不同种子产生不同的长度/拷贝数/染色体间比例分布
- 更多/更少的样本落在决策边界附近
- U 的唯一性约束较为保守：边界样本数量直接影响 U/M 的 FN

**建议**：使用**多次运行（均值 ± 标准差）**报告 recall，而不是追求单次 100%。

---

## 13. Pytest 回归基线

为了 CI/本地回归测试，仓库包含一个**小规模、固定种子**的基线：

| 组件 | 路径 |
|------|------|
| 基线文件 | `tests/simulation/baselines/synthetic_regression.json` |
| 测试用例 | `tests/simulation/test_simulation_regression_baseline.py` |
| 更新脚本 | `tests/simulation/update_synthetic_baseline.py` |

**运行**：
```bash
pytest -q tests/simulation/test_simulation_regression_baseline.py
```

**更新基线**（当有意更改算法/参数时）：
```bash
python tests/simulation/update_synthetic_baseline.py
```

---

## 14. 负控制：假阳性约束

负控制用于约束重复/低复杂度区域的低 MAPQ 假阳性：

- 构造 `MAPQ=0` 的全覆盖比对
- 断言不会产生高置信度的 U 调用（`confidence_score >= 0.8`）
- 测试：`test_negative_control_low_mapq_has_no_high_confidence_calls`

---

## 15. 参考

- 验证脚本：`tests/simulation/`
- 结果报告：`docs/Validation_Report.md`
- 性能图表：`docs/images/validation_combined.png`
